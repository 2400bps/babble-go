# Simulate the environment used by Travis CI so that we can run local tests to
# find and resolve issues that are consistent with the Travis CI environment.
# This is helpful because Travis CI often finds issues that our own local tests
# do not.

go vet                  `go list ./... | grep -Ev "(vendor)"` && \
golint -set_exit_status `go list ./... | grep -Ev "(vendor)"` && \

# Test and generate cover profiles
ginkgo --cover driver/grpc        \
driver/leveldb                  &&\

# Merge cover profiles into one root cover profile
covermerge driver/grpc/grpc.coverprofile                   \
driver/leveldb/leveldb.coverprofile                      \
> xoxo.coverprofile

# Remove auto-generated protobuf files
sed -i.bak '/.pb.go/d' xoxo.coverprofile

# Remove marshaling files
sed -i.bak '/marshal.go/d' xoxo.coverprofile

rm *.bak